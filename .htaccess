
# Toloni Pescarias - Security & Configuration

# Enable Rewrite Engine
RewriteEngine On

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Security Headers & CORS
<IfModule mod_headers.c>
    # CORS Headers - Configuração dinâmica para desenvolvimento e produção
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "86400"
    
    # Configurar Access-Control-Allow-Origin dinamicamente
    SetEnvIf Origin "^https?://(localhost|127\.0\.0\.1|192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[0-1])\.|.*\.lovable\.)" IS_DEV_ORIGIN=1
    SetEnvIf Origin "^https://(www\.)?tolonipescarias\.com\.br$" IS_PROD_ORIGIN=1
    
    Header always set Access-Control-Allow-Origin "%{HTTP_ORIGIN}e" env=IS_DEV_ORIGIN
    Header always set Access-Control-Allow-Origin "%{HTTP_ORIGIN}e" env=IS_PROD_ORIGIN
    Header always set Access-Control-Allow-Origin "https://tolonipescarias.com.br" env=!IS_DEV_ORIGIN:!IS_PROD_ORIGIN
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options nosniff
    
    # Prevent clickjacking
    Header always set X-Frame-Options DENY
    
    # Enable XSS filtering
    Header always set X-XSS-Protection "1; mode=block"
    
    # Force HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Content Security Policy - Updated for better compatibility
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://www.google.com https://www.gstatic.com https://cdn.gpteng.co; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; media-src 'self' https:; connect-src 'self' https: wss: data:; frame-src 'self' https://www.google.com; object-src 'none'; base-uri 'self'; form-action 'self';"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Feature Policy
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
    
    # Remove server information
    Header unset Server
    Header unset X-Powered-By
    Header unset X-AspNet-Version
    Header unset X-AspNetMvc-Version
</IfModule>

# Hide server signature
ServerTokens Prod
ServerSignature Off

# Tratar requisições OPTIONS globalmente para CORS
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=204,L]

# URLs amigáveis
RewriteRule ^location/([0-9]+)/?$ pages/location_detail.php?id=$1 [L,QSA]
RewriteRule ^locations/([0-9]+)/?$ pages/location_detail.php?id=$1 [L,QSA]
RewriteRule ^report/([0-9]+)/?$ pages/report_detail.php?id=$1 [L,QSA]
RewriteRule ^reports/([0-9]+)/?$ pages/report_detail.php?id=$1 [L,QSA]
RewriteRule ^user/([0-9]+)/?$ pages/user_profile.php?id=$1 [L,QSA]
RewriteRule ^profile/([0-9]+)/?$ pages/user_profile.php?id=$1 [L,QSA]

# Admin routes
RewriteRule ^admin/?$ admin/index.php [L,QSA]
RewriteRule ^admin/([a-zA-Z_]+)/?$ admin/$1.php [L,QSA]

# API routes
RewriteRule ^api/([a-zA-Z_]+)/?$ api/$1.php [L,QSA]

# Para SPA React - redirecionar todas as rotas para index.html (apenas se não for API ou arquivo estático)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/admin/
RewriteCond %{REQUEST_URI} !^/assets/
RewriteRule . /index.html [L]

# Protect sensitive files and directories
<Files "*.sql">
    Require all denied
</Files>

<Files "*.log">
    Require all denied
</Files>

<Files ".env">
    Require all denied
</Files>

<Files ".htaccess">
    Require all denied
</Files>

<Files "composer.json">
    Require all denied
</Files>

<Files "composer.lock">
    Require all denied
</Files>

<Files "*.md">
    Require all denied
</Files>

# Protect config directory
<DirectoryMatch "^.*/config/">
    Require all denied
</DirectoryMatch>

# Protect includes directory
<DirectoryMatch "^.*/includes/">
    Require all denied
</DirectoryMatch>

# Protect database directory
<DirectoryMatch "^.*/database/">
    Require all denied
</DirectoryMatch>

# Protect backup directory
<DirectoryMatch "^.*/backups/">
    Require all denied
</DirectoryMatch>

# Protect uploads directory from PHP execution
<Directory "assets/uploads">
    php_flag engine off
    Options -ExecCGI -Indexes
    AddHandler cgi-script .php .pl .py .jsp .asp .sh .cgi
    
    <Files "*.php">
        Require all denied
    </Files>
    
    <Files "*.phtml">
        Require all denied
    </Files>
    
    <Files "*.php3">
        Require all denied
    </Files>
    
    <Files "*.php4">
        Require all denied
    </Files>
    
    <Files "*.php5">
        Require all denied
    </Files>
    
    <Files "*.inc">
        Require all denied
    </Files>
</Directory>

# Prevent access to specific file types
<FilesMatch "\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|swp|orig)$">
    Require all denied
</FilesMatch>

# Prevent access to version control directories
<DirectoryMatch "^.*\.(git|svn|hg|bzr)">
    Require all denied
</DirectoryMatch>

# Block bad bots and suspicious requests
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} (binlar|casper|cmsworldmap|comodo|curl|diavol|dotbot|feedfinder|flicky|ia_archiver|jakarta|kmccrew|nutch|planetwork|purebot|pycurl|skygrid|sucker|turnit|vikspider|winhttp|xxxyy|youda|zmeu|zune) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Prevent image hotlinking
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?tolonipescarias\.com [NC]
    RewriteCond %{REQUEST_URI} \.(gif|jpe?g|png|webp)$ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Expire headers for caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Prevent SQL injection attempts
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (union|select|insert|delete|drop|update|md5|benchmark|or.1=1|or.1=|or.1|or 1=1|or 1=|or 1) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Prevent XSS attempts
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*iframe.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*object.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*embed.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*marquee.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} javascript: [NC,OR]
    RewriteCond %{QUERY_STRING} vbscript: [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Limit file upload size (50MB)
LimitRequestBody 52428800

# Limit request timeout
Timeout 300

# Error pages
ErrorDocument 400 /error/400.html
ErrorDocument 401 /error/401.html
ErrorDocument 403 /error/403.html
ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html

# Directory browsing protection
Options -Indexes

# Follow symbolic links security
Options -FollowSymLinks

# Prevent access to PHP error logs
<Files "error_log">
    Require all denied
</Files>

# Rate limiting (basic)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# Additional security for admin area
<Directory "admin">
    # Additional protection can be added here
    # For example: IP whitelist for admin access
    # Require ip 192.168.1.100
    # Require ip 10.0.0.0/8
</Directory>

# Prevent execution of uploaded files
<Directory "assets/uploads">
    RemoveHandler .php .phtml .php3 .php4 .php5 .inc
    RemoveType .php .phtml .php3 .php4 .php5 .inc
    php_flag engine off
</Directory>

# SSL/TLS Security (if mod_ssl is available)
<IfModule mod_ssl.c>
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
</IfModule>
